---
import BaseLayout from '../../layouts/BaseLayout.astro';
import FileIcon from '../../components/FileIcon.astro';
import FolderIcon from '../../components/FolderIcon.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const folders = new Set();

  posts.forEach((post) => {
    const parts = post.slug.split('/');
    for (let i = 1; i < parts.length; i++) {
      folders.add(parts.slice(0, i).join('/'));
    }
  });

  const postPaths = posts.map((post) => ({
    params: { segments: post.slug },
  }));
  const folderPaths = Array.from(folders).map((slug) => ({
    params: { segments: slug },
  }));

  return [...postPaths, ...folderPaths];
}

const posts = await getCollection('blog');
const segmentsRaw = Astro.params.segments;
const segments = typeof segmentsRaw === 'string'
  ? segmentsRaw.split('/').filter(Boolean)
  : Array.isArray(segmentsRaw)
    ? segmentsRaw
    : [];

const slugPath = segments.join('/');
const post = posts.find((p) => p.slug === slugPath) ?? null;
const Content = post ? (await post.render()).Content : null;

const formatYMD = (d) => {
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0, 10);
};

const titleCase = (value) =>
  value
    .split('-')
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
    .join(' ');

const latestDateFor = (slugPrefix) => {
  const prefix = slugPrefix ? `${slugPrefix}/` : '';
  let latest = null;
  posts.forEach((p) => {
    if (!prefix || p.slug.startsWith(prefix)) {
      latest = !latest || p.data.date > latest ? p.data.date : latest;
    }
  });
  return latest ? formatYMD(latest) : null;
};

const listAtPath = (pathSegments) => {
  const folderMap = new Map();
  const files = [];

  posts.forEach((entry) => {
    const parts = entry.slug.split('/');
    if (!pathSegments.every((seg, idx) => parts[idx] === seg)) return;
    if (parts.length === pathSegments.length) return;

    if (parts.length === pathSegments.length + 1) {
      files.push(entry);
      return;
    }

    const child = parts[pathSegments.length];
    if (!folderMap.has(child)) {
      const slug = [...pathSegments, child].join('/');
      folderMap.set(child, {
        slug,
        label: titleCase(child),
        lastUpdated: latestDateFor(slug),
      });
    }
  });

  files.sort((a, b) =>
    a.data.title.localeCompare(b.data.title, 'en', { sensitivity: 'base' }),
  );
  const folders = Array.from(folderMap.values()).sort((a, b) =>
    a.label.localeCompare(b.label, 'en', { sensitivity: 'base' }),
  );

  return { folders, files };
};

const folderSegments = post ? segments.slice(0, -1) : segments;

const folderCrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog' },
  ...folderSegments.map((segment, idx) => {
    const href = `/blog/${folderSegments.slice(0, idx + 1).join('/')}/`;
    return { label: titleCase(segment), href };
  }),
];

const breadcrumbs = post
  ? [...folderCrumbs, { label: post.data.title }]
  : folderCrumbs.map((crumb, idx) =>
      idx === folderCrumbs.length - 1 ? { ...crumb, href: undefined } : crumb,
    );

const { folders, files } = post ? { folders: [], files: [] } : listAtPath(segments);
const heading =
  folderSegments.length === 0 ? 'Blog' : titleCase(folderSegments[folderSegments.length - 1]);
---

<BaseLayout
  title={post ? `${post.data.title} | Blog` : `${heading} | Blog`}
  breadcrumbs={breadcrumbs}
  pageId="page-blog"
>
  {
    post ? (
      <main class="post-page">
        <section class="post-hero">
          <h1 class="post-title-hero">{post.data.title}</h1>
          <div class="post-meta">
            <p class="post-date">{formatYMD(post.data.date)}</p>
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="tag-row">
                {post.data.tags.map((tag) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </div>
        </section>

        <article class="prose-content">
          {Content && <Content />}
        </article>
      </main>
    ) : (
      <>
        <section class="hero">
          <h1 class="caps">{heading}</h1>
        </section>

        <section class="entry-list">
          {folders.map((folder) => (
            <a class="entry-card folder" href={`/blog/${folder.slug}/`}>
              <span class="entry-icon" aria-hidden="true"><FolderIcon /></span>
              <div class="entry-body">
                <div class="entry-title">{folder.label}</div>
              </div>
              <div class="entry-meta">
                {folder.lastUpdated ? `Updated: ${folder.lastUpdated}` : "Empty"}
              </div>
            </a>
          ))}

          {files.map((entry) => (
            <a class="entry-card file" href={`/blog/${entry.slug}/`}>
              <span class="entry-icon" aria-hidden="true"><FileIcon /></span>
              <div class="entry-body">
                <div class="entry-title">{entry.data.title}</div>
              </div>
              <div class="entry-meta">Added: {formatYMD(entry.data.date)}</div>
            </a>
          ))}
        </section>
      </>
    )
  }
</BaseLayout>

<style>
  .post-page {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .post-hero {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0;
  }

  .post-title-hero {
    margin: 0;
    font-size: clamp(2.5rem, 6vw, 3.75rem);
    letter-spacing: 0.08em;
    text-transform: none;
    line-height: 1.1;
    font-family: 'Share Tech', 'Geist Mono', 'FiraCode', 'Geist', 'Inter', system-ui, -apple-system, sans-serif;
    padding: var(--card-padding) 0;
  }

  .post-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 0 0 var(--card-padding);
    border-bottom: 1px solid var(--border);
  }

  .post-date {
    margin: 0;
    color: var(--muted);
    font-size: 0.95rem;
  }

  .tag-row {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
    margin: 0;
    flex: 1 1 auto;
  }

  .tag {
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.85rem;
  }

  .prose-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .prose-content :global(p) {
    margin: 0 0 1rem;
    line-height: 1.7;
  }

  .prose-content :global(a) {
    color: var(--accent-highlight);
  }
</style>
