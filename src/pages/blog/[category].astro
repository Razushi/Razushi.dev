---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const categories = Array.from(
    new Set(
      posts.map((p) => {
        const raw = (p.data.category ?? '').toString().trim();
        const base = raw || 'general';
        const labelSource =
          base.includes('-') && !base.includes(' ')
            ? base.replace(/-/g, ' ')
            : base;
        const slug =
          labelSource
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '') || 'general';
        return slug;
      }),
    ),
  );
  return categories.map((categorySlug) => ({
    params: { category: categorySlug },
  }));
}

const { category } = Astro.params;
if (!category) {
  throw new Error('Category missing');
}

const normalizeCategory = (value?: string) => {
  const raw = (value ?? '').toString().trim();
  const base = raw || 'general';
  const labelSource =
    base.includes('-') && !base.includes(' ')
      ? base.replace(/-/g, ' ')
      : base;
  const words = labelSource
    .split(/\s+/)
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  const label = words.join(' ') || 'General';
  const slug =
    labelSource
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '') || 'general';
  return { slug, label };
};

const categoryKey = normalizeCategory(category).slug;

const posts = (await getCollection('blog')).filter(
  (p) => {
    const { slug } = normalizeCategory(p.data.category);
    return slug === categoryKey;
  },
);
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const formatDate = (d: Date) => {
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0, 10); // yyyy-mm-dd
};

const categoryName = normalizeCategory(category).label;
---

<BaseLayout
  title={`${categoryName} | Blog`}
  breadcrumbs={[
    { label: "Home", href: "/" },
    { label: "Blog", href: "/blog" },
    { label: categoryName },
  ]}
  pageId="page-blog"
>
  <section class="hero">
    <h1 class="caps">{categoryName}</h1>
  </section>

  <main class="blog-index">
    <section class="category-block">
      <ul class="post-list">
        {posts.map((post) => (
          <li class="post-list-item">
            <span class="post-date">{formatDate(post.data.date)}</span>
            <a class="post-title" href={`/blog/${post.slug}/`}>{post.data.title}</a>
          </li>
        ))}
      </ul>
    </section>
  </main>
</BaseLayout>
