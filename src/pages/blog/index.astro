---
import BaseLayout from '../../layouts/BaseLayout.astro';
import FileIcon from '../../components/FileIcon.astro';
import FolderIcon from '../../components/FolderIcon.astro';
import { getCollection } from 'astro:content';

const slugifySegment = (value: string) =>
  value
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');

const formatYMD = (d: Date) => {
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0, 10);
};

const posts = await getCollection('blog');
const meta = posts.map((entry) => {
  const rawPath = entry.id.replace(/^blog\//, '').replace(/\.md$/, '');
  const rawSegments = rawPath.split('/');
  const slugSegments = rawSegments.map(slugifySegment);
  const slugPath = slugSegments.join('/');
  return { entry, rawSegments, slugSegments, slugPath };
});

const latestDateFor = (slugPrefix: string) => {
  const prefix = slugPrefix ? `${slugPrefix}/` : '';
  let latest: Date | null = null;
  meta.forEach((item) => {
    if (!prefix || item.slugPath.startsWith(prefix)) {
      latest = !latest || item.entry.data.date > latest ? item.entry.data.date : latest;
    }
  });
  return latest ? formatYMD(latest) : null;
};

const listAtPath = (slugSegments: string[]) => {
  const folderMap = new Map<string, { slug: string; label: string; lastUpdated: string | null }>();
  const files: typeof meta[number][] = [];

  meta.forEach((item) => {
    if (!slugSegments.every((seg, idx) => item.slugSegments[idx] === seg)) return;
    if (item.slugSegments.length === slugSegments.length) return;

    if (item.slugSegments.length === slugSegments.length + 1) {
      files.push(item);
      return;
    }

    const childSlug = item.slugSegments[slugSegments.length];
    if (!folderMap.has(childSlug)) {
      const slug = [...slugSegments, childSlug].join('/');
      folderMap.set(childSlug, {
        slug,
        label: item.rawSegments[slugSegments.length] ?? childSlug,
        lastUpdated: latestDateFor(slug),
      });
    }
  });

  files.sort((a, b) =>
    a.entry.data.title.localeCompare(b.entry.data.title, 'en', { sensitivity: 'base' }),
  );
  const folders = Array.from(folderMap.values()).sort((a, b) =>
    a.label.localeCompare(b.label, 'en', { sensitivity: 'base' }),
  );

  return { folders, files };
};

const { folders, files } = listAtPath([]);
---

<BaseLayout
  title="Blog | Vestige"
  breadcrumbs={[{ label: "Home", href: "/" }, { label: "Blog" }]}
  pageId="page-blog"
>
  <section class="hero">
    <h1 class="caps">Blog</h1>
  </section>

  <section class="entry-list">
    {folders.map((folder) => (
      <a class="entry-card folder" href={`/blog/${folder.slug}/`}>
        <span class="entry-icon" aria-hidden="true"><FolderIcon /></span>
        <div class="entry-body">
          <div class="entry-title">{folder.label}</div>
        </div>
        <div class="entry-meta">
          {folder.lastUpdated ? `Updated: ${folder.lastUpdated}` : "Empty"}
        </div>
      </a>
    ))}

    {files.map((post) => (
      <a class="entry-card file" href={`/blog/${post.slugPath}/`}>
        <span class="entry-icon" aria-hidden="true"><FileIcon /></span>
        <div class="entry-body">
          <div class="entry-title">{post.entry.data.title}</div>
        </div>
        <div class="entry-meta">Added: {formatYMD(post.entry.data.date)}</div>
      </a>
    ))}
  </section>
</BaseLayout>
