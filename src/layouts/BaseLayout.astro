---
import '../styles/palette.css';
import FireIcon from '../components/FireIcon.astro';

interface Crumb {
  label: string;
  href?: string;
}

const {
  title = 'Vestige',
  description = 'Personal writing & notes',
  breadcrumbs = [],
}: { title?: string; description?: string; breadcrumbs?: Crumb[] } = Astro.props;

const currentPath = Astro.url.pathname;
const isHome = currentPath === '/';
const isActive = (path: string) =>
  currentPath === path || currentPath.startsWith(`${path}/`);
---

<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>
  <body class="site-shell">
    <header class="site-header">
      <div class="wrap nav">
        <a class={`brand ${isHome ? 'active' : ''}`} href="/">
          <span><FireIcon /></span>
          Vestige
        </a>
        <nav class="nav-links">
          <a class={isActive('/blog') ? 'active' : ''} href="/blog">Blog</a>
          <a class={isActive('/tests') ? 'active' : ''} href="/tests">Tests</a>
          <a class={isActive('/about') ? 'active' : ''} href="/about">About</a>
          <a href="https://github.com/Razushi" target="_blank" rel="noreferrer">GitHub</a>
        </nav>
        <button
          class="theme-toggle"
          type="button"
          id="theme-toggle"
          aria-label="Change theme"
          data-theme-state="dark"
        >
          <svg class="icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="12" cy="12" r="4" />
            <line x1="12" y1="3" x2="12" y2="5" />
            <line x1="12" y1="19" x2="12" y2="21" />
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            <line x1="3" y1="12" x2="5" y2="12" />
            <line x1="19" y1="12" x2="21" y2="12" />
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
          </svg>
          <svg class="icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path
              d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <svg class="icon icon-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path
              d="m12 3 2.09 5.74L20 9.27l-4.5 3.9L16.18 19 12 15.98 7.82 19l0.68-5.83L4 9.27l5.91-0.53L12 3Z"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
    </header>
    <div class="wrap page-wrap">
      {breadcrumbs.length > 0 && (
        <nav class="breadcrumb" aria-label="Breadcrumb">
          {
            breadcrumbs.map((crumb, index) => {
              const isLast = index === breadcrumbs.length - 1;
              return (
                <>
                  {crumb.href && !isLast ? (
                    <a href={crumb.href}>{crumb.label}</a>
                  ) : (
                    <span class={isLast ? 'current' : ''}>{crumb.label}</span>
                  )}
                  {!isLast && <span aria-hidden="true">/</span>}
                </>
              );
            })
          }
        </nav>
      )}
      <slot />
    </div>
    <footer class="site-footer">
      <div class="wrap">&copy; {new Date().getFullYear()} Razushi &middot; Built with Astro + Svelte</div>
    </footer>
  </body>
</html>

<script>
  const themeOrder = ["dark", "light", "night"];
  const storageKey = "epithet-theme";
  const storageAccentKey = "epithet-accent";
  const root = document.documentElement;
  const btn = document.getElementById("theme-toggle");
  const shell = document.querySelector(".site-shell");
  const storedAccent = (() => {
    try {
      return localStorage.getItem(storageAccentKey);
    } catch {
      return null;
    }
  })();
  const defaultAccent =
    storedAccent ||
    getComputedStyle(root).getPropertyValue("--accent-highlight").trim() ||
    "#d45658";

  const applyAccent = (accent) => {
    root.style.setProperty("--accent-highlight", accent);
    root.style.setProperty("--accent-teal", accent);
    root.style.setProperty("--accent-copper", accent);
  };

  const applyTheme = (theme) => {
    root.dataset.theme = theme;
    root.dataset.themeState = theme;
    applyAccent(storedAccent || defaultAccent);

    if (btn) {
      btn.setAttribute("data-theme-state", theme);
      btn.setAttribute("aria-label", `Change theme (current: ${theme})`);
    }
    try {
      localStorage.setItem(storageKey, theme);
    } catch (_err) {
      /* ignore storage errors */
    }
  };

  const stored = (() => {
    try {
      return localStorage.getItem(storageKey);
    } catch (_err) {
      return null;
    }
  })();

  const initial = stored || "dark";
  applyTheme(initial);

  btn?.addEventListener("click", () => {
    const current = root.dataset.theme || "dark";
    const currentState = btn.getAttribute("data-theme-state") || current;
    const idx = themeOrder.indexOf(currentState);
    const next = themeOrder[(idx + 1) % themeOrder.length];
    applyTheme(next);
  });

  const updateVignette = () => {
    if (!shell) return;
    const scrollY = window.scrollY || window.pageYOffset;
    const max = document.documentElement.scrollHeight - window.innerHeight;
    const atBottom = scrollY >= max - 1;
    shell.classList.toggle("vignette-bottom-hidden", atBottom);
  };

  window.addEventListener("scroll", updateVignette, { passive: true });
  window.addEventListener("resize", updateVignette);
  updateVignette();
</script>
